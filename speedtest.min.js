function Speedtest(){this._serverList=[],this._selectedServer=null,this._settings={},this._state=0}Speedtest.prototype={constructor:Speedtest,getState:function(){return this._state},setParameter:function(t,e){if(3==this._state)throw"You cannot change the test settings while running the test";this._settings[t]=e,"telemetry_extra"===t&&(this._originalExtra=this._settings.telemetry_extra)},_checkServerDefinition:function(t){try{if("string"!=typeof t.name)throw"Name string missing from server definition (name)";if("string"!=typeof t.server)throw"Server address string missing from server definition (server)";if("/"!=t.server.charAt(t.server.length-1)&&(t.server+="/"),0==t.server.indexOf("//")&&(t.server=location.protocol+t.server),"string"!=typeof t.dlURL)throw"Download URL string missing from server definition (dlURL)";if("string"!=typeof t.ulURL)throw"Upload URL string missing from server definition (ulURL)";if("string"!=typeof t.pingURL)throw"Ping URL string missing from server definition (pingURL)";if("string"!=typeof t.getIpURL)throw"GetIP URL string missing from server definition (getIpURL)"}catch(t){throw"Invalid server definition"}},addTestPoint:function(t){if(this._checkServerDefinition(t),0==this._state&&(this._state=1),1!=this._state)throw"You can't add a server after server selection";this._settings.mpot=!0,this._serverList.push(t)},addTestPoints:function(t){for(var e=0;e<t.length;e++)this.addTestPoint(t[e])},loadServerList:function(t,e){if(0==this._state&&(this._state=1),1!=this._state)throw"You can't add a server after server selection";this._settings.mpot=!0;var s=new XMLHttpRequest;s.onload=function(){try{for(var t=JSON.parse(s.responseText),i=0;i<t.length;i++)this._checkServerDefinition(t[i]);this.addTestPoints(t),e(t)}catch(t){e(null)}}.bind(this),s.onerror=function(){e(null)},s.open("GET",t),s.send()},getSelectedServer:function(){if(this._state<2||null==this._selectedServer)throw"No server is selected";return this._selectedServer},setSelectedServer:function(t){if(this._checkServerDefinition(t),3==this._state)throw"You can't select a server while the test is running";this._selectedServer=t,this._state=2},selectServer:function(t){if(1!=this._state){if(0==this._state)throw"No test points added";if(2==this._state)throw"Server already selected";if(this._state>=3)throw"You can't select a server while the test is running"}if(this._selectServerCalled)throw"selectServer already called";this._selectServerCalled=!0;for(var e=function(t,e){var s=!0;/MSIE.(\d+\.\d+)/i.test(navigator.userAgent)&&(s=!1);var i=function(t,e){t+=(t.match(/\?/)?"&":"?")+"cors=true";var i=new XMLHttpRequest,r=(new Date).getTime();if(i.onload=function(){if(0==i.responseText.length){var s=(new Date).getTime()-r;try{var n=performance.getEntriesByName(t),o=(n=n[n.length-1]).responseStart-n.requestStart;o<=0&&(o=n.duration),o>0&&o<s&&(s=o)}catch(t){}e(s)}else e(-1)}.bind(this),i.onerror=function(){e(-1)}.bind(this),i.open("GET",t),s)try{i.timeout=2e3,i.ontimeout=i.onerror}catch(t){}i.send()}.bind(this),r=function(t,e){var s=0;if(t.pingT=-1,-1==t.server.indexOf(location.protocol))e();else{var r=function(){3!=s++?i(t.server+t.pingURL,function(s){s>=0?((s<t.pingT||-1==t.pingT)&&(t.pingT=s),s<500?r():e()):e()}.bind(this)):e()}.bind(this);r()}}.bind(this),n=0,o=function(){for(var s=null,i=0;i<t.length;i++)-1!=t[i].pingT&&(null==s||t[i].pingT<s.pingT)&&(s=t[i]);e(s)}.bind(this),a=function(){n!=t.length?r(t[n++],a):o()}.bind(this);a()}.bind(this),s=[],i=0;i<6;i++)s[i]=[];for(i=0;i<this._serverList.length;i++)s[i%6].push(this._serverList[i]);var r=0,n=null;for(i=0;i<6;i++)e(s[i],function(e){null!=e&&(null==n||e.pingT<n.pingT)&&(n=e),6==++r&&(this._selectedServer=n,this._state=2,t&&t(n))}.bind(this))},start:function(){if(3==this._state)throw"Test already running";if(this.worker=new Worker("speedtest_worker.js?r="+Math.random()),this.worker.onmessage=function(t){if(t.data!==this._prevData){this._prevData=t.data;var e=JSON.parse(t.data);try{this.onupdate&&this.onupdate(e)}catch(t){}if(e.testState>=4){clearInterval(this.updater),this._state=4;try{this.onend&&this.onend(5==e.testState)}catch(t){}}}}.bind(this),this.updater=setInterval(function(){this.worker.postMessage("status")}.bind(this),200),1==this._state)throw"When using multiple points of test, you must call selectServer before starting the test";2==this._state&&(this._settings.url_dl=this._selectedServer.server+this._selectedServer.dlURL,this._settings.url_ul=this._selectedServer.server+this._selectedServer.ulURL,this._settings.url_ping=this._selectedServer.server+this._selectedServer.pingURL,this._settings.url_getIp=this._selectedServer.server+this._selectedServer.getIpURL,void 0!==this._originalExtra?this._settings.telemetry_extra=JSON.stringify({server:this._selectedServer.name,extra:this._originalExtra}):this._settings.telemetry_extra=JSON.stringify({server:this._selectedServer.name})),this._state=3,this.worker.postMessage("start "+JSON.stringify(this._settings))},abort:function(){if(this._state<3)throw"You cannot abort a test that's not started yet";this._state<4&&this.worker.postMessage("abort")}};var s=new Speedtest;function startStop(){3==s.getState()?s.abort():(s.start(),interface("startStopBtn").className="running")}function initUI(){interface("dlText").textContent="",interface("ulText").textContent="",interface("pingText").textContent="",interface("jitText").textContent="",interface("ip").textContent=""}function interface(t){return document.getElementById(t)}s.onupdate=function(t){interface("ip").textContent=t.clientIp,interface("dlText").textContent=1==t.testState&&0==t.dlStatus?"...":t.dlStatus,interface("ulText").textContent=3==t.testState&&0==t.ulStatus?"...":t.ulStatus,interface("pingText").textContent=t.pingStatus,interface("jitText").textContent=t.jitterStatus;var e=(2*Number(t.dlProgress)+2*Number(t.ulProgress)+Number(t.pingProgress))/5;interface("progress").style.width=100*e+"%"},s.onend=function(t){interface("startStopBtn").className="",t&&initUI()};